<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Create a div where the graph will take place -->
<div id="the_jordan_effect"></div>
  <style>
    rect {
      stroke: black;
    }
  </style>
  <body>
    <script>
        // set the dimensions and margins of the graph
        var margin = {top: 10, right: 30, bottom: 30, left: 60},
            width = 700 - margin.left - margin.right,
            height = 700 - margin.top - margin.bottom;
        
        // append the svg object to the body of the page
        var svg = d3.select("#the_jordan_effect")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                    "translate("+margin.left+", "+margin.top+")");

        // Start year
        var cur_year = 2019;
        // Read the data and draw the first scene
        d3.csv("https://raw.githubusercontent.com/Zman94/the_jordan_effect_dashboard/master/data/Attendance_plus_final.csv", function(data) {
          drawMainCanvas(cur_year);

          // svg.on("wheel", function() {
          //   var direction = d3.event.wheelDelta < 0 ? 'down' : 'up';
          //   console.log(d3.event.wheelDelta);
          //   if (direction == 'down') {
          //     cur_year = cur_year - 1;
          //     if (cur_year < 1969)
          //       cur_year = 1969;
          //   }
          //   else {
          //     cur_year = cur_year + 1
          //     if (cur_year > 2019)
          //       cur_year = 2019;
          //   }
          //   console.log(cur_year);
          //   drawMainCanvas(cur_year);
          // });
          svg.append('rect') // append a rect to catch mouse movements on canvas
            .attr('width', width) // can't catch mouse events on a g element
            .attr('height', height)
            .attr('fill', 'none')
            .attr('pointer-events', 'all')
            .on('wheel', function() { console.log("helloworld"); }); // mouse moving over canva

          d3.select("svg").on("scroll", function () { console.log("hello") });
          d3.select("svg").on("Scroll", function () { console.log("hello2") });
          // var zoom = d3.behavior.zoom().on('zoom', update);
          // svg.call(zoom)
          //   .on("mousedown.zoom", console.log("mousedown"))
          //   .on("mouseup.zoom", console.log("mousedown2"));


          // Scene draw helper
          function drawMainCanvas(data_year) {
            // Grab this year's data and sort
            var cur_year_data = data.filter(function(d){ return d.Year == data_year.toString()})
            cur_year_data.sort(function(x, y){
              return d3.descending(x.AttendG, y.AttendG);
            })

            // X axis
            var x = d3.scaleBand()
              .range([ 0, width ])
              .domain(cur_year_data.map(function(d) { return d.Tm; }))
              .padding(0.1);
            svg.append("g")
              .attr("transform", "translate(0," + height + ")")
              .call(d3.axisBottom(x))
              .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            // Add Y axis
            var y = d3.scaleLinear()
              .domain([0, 50000])
              .range([ height, 0]);
            svg.append("g")
              .call(d3.axisLeft(y));

            // Debugging
            // console.log(cur_year_data);

            // create a tooltip
            var Tooltip = d3.select("#the_jordan_effect")
              .append("div")
              .style("opacity", 0)
              .attr("class", "tooltip")
              .style("background-color", "white")
              .style("border", "solid")
              .style("border-width", "2px")
              .style("border-radius", "5px")
              .style("padding", "5px")

            // Three function that change the tooltip when user hover / move / leave a cell
            var mouseover = function(d) {
              Tooltip
                .style("opacity", 1)
              d3.select(this)
                .style("stroke-width", "2")
                .style("opacity", 1)
            }
            var mousemove = function(d) {
              Tooltip
                .html("The " + d.TmName + " Average Home Game Attendence " + d.AttendG + "<br>" + d.Year)
                .style("left", (d3.mouse(this)[x]+70) + "px")
                .style("top", (d3.mouse(this)[y]) + "px")
            }
            var mouseleave = function(d) {
              Tooltip
                .style("opacity", 0)
              d3.select(this)
                .style("stroke-width", "1")
                .style("opacity", 0.8)
            }

            // Add bars
            svg.append('g')
            .selectAll("rect")
            .data(cur_year_data)
            .enter()
            .append("rect")
                .attr("width", x.bandwidth())
                .attr("height", function (d) {
                  // console.log(height-y(d.AttendG.replace(/\,/g,'')));
                  return height-y(d.AttendG.replace(/\,/g,'')); })
                .attr("x", function(d) {
                  // console.log(x(d.Tm));
                  return x(d.Tm); })
                .attr("y", function(d) {
                  // console.log(d.AttendG.replace(/\,/g,''));
                  return y(d.AttendG.replace(/\,/g,'')); } )
                .attr("fill", function(d) {
                  // console.log(d.TmColor);
                  return d.TmColor; })
                .attr("opacity", 0.8)
            .on("Scroll", function() { console.log("testing"); })
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave);
          }

          // Adjust data on mouse scroll
        });
    </script>
  </body>
</html>