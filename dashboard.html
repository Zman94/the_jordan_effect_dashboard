<!-- /*
TODO:
combine Marlins 
Add world series winner marker
Fix slider
Set description up top
refactor tooltip
*/ -->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>
<script src="d3-tip.js"></script>

<!-- Return to main viz -->
<button id="retButton">Return to Home Graph</button>

<!-- Create a div where the graph will take place -->
<div id="the_jordan_effect"></div>
  <style>
    rect {
      stroke: black;
    }
  </style>
  <!-- Tooltip styling -->
  <style>   
  .d3-tip {
    line-height: 1;
    font-weight: bold;
    padding: 12px;
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    border-radius: 2px;
    pointer-events: none;
  }

  /* Creates a small triangle extender for the tooltip */
  .d3-tip:after {
    box-sizing: border-box;
    display: inline;
    font-size: 10px;
    width: 100%;
    line-height: 1;
    color: rgba(0, 0, 0, 0.8);
    position: absolute;
    pointer-events: none;
  }
  /* Southward tooltips */
  .d3-tip.s:after {
    content: "\25B2";
    margin: 0 0 1px 0;
    top: -8px;
    left: 0;
    text-align: center;
  }
  </style>
  <body>
    <div class="row align-items-center">
      <div class="col-sm-2"><p id="value-time"></p></div>
      <div class="col-sm"><div id="slider-time"></div></div>
    </div>
    <script>
      // Start year
      var cur_year = 2019;

      // set the dimensions and margins of the graph
      var margin = {top: 30, right: 30, bottom: 30, left: 60},
          width = 1200 - margin.left - margin.right,
          height = 700 - margin.top - margin.bottom;
      
      // Time
      var dataTime = d3.range(0, 51).map(function(d) {
        return new Date(1969 + d, 10, 3);
      });

      // append the svg object to the body of the page
      var svg = d3.select("#the_jordan_effect")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform",
                  "translate("+margin.left+", "+margin.top+")");

      // Read the data and draw the first scene
      d3.csv("https://raw.githubusercontent.com/Zman94/the_jordan_effect_dashboard/master/data/Attendance_plus_final.csv", function(data) {

        // Setup the tool tip.  Note that this is just one example, and that many styling options are available.
        // See original documentation for more details on styling: http://labratrevenge.com/d3-tip/
        var tool_tip = d3.tip()
          .attr("class", "d3-tip")
          .offset([50, 0])
          .direction('s')
          .html(function(d) { return d.TmName + " had an average<br>attendance/game of " + d.AttendG + " in " + d.Year; });
        svg.call(tool_tip);

        var mouseover = function(d) {
          tool_tip.show(d);
          d3.select(this)
            .style("stroke-width", "3")
            .style("opacity", 0.5)
        }
        var mouseleave = function(d) {
          tool_tip.hide(d);
          d3.select(this)
            .style("stroke-width", "1")
            .style("opacity", 1)
        }

        var mouseclick = function(d) {
          tool_tip.hide(d);
          drawDetailCanvas(d.Tm);
        }

        // Modify Slider Attributes
        var sliderTime = d3.sliderBottom()
          .min(d3.min(dataTime))
          .max(d3.max(dataTime))
          .step(1000 * 60 * 60 * 24 * 365)
          .width(width-50)
          .tickFormat(d3.timeFormat('%Y'))
          .tickValues(dataTime)
          .default(new Date(2019, 10, 3))
          .on('onchange', num => {
            cur_year = d3.timeFormat('%Y')(num);
            drawMainCanvas(cur_year);
            d3.select('p#value-time').text("Current year: " + cur_year);
          })

        var gTime = d3.select('div#slider-time')
          .append('svg')
          .attr('width', width-50)
          .attr('height', 100)
          .append('g')
          .attr('transform', "translate("+(margin.left+25)+", "+margin.top+")");


        gTime.call(sliderTime);

        d3.select('p#value-time').text("Current year: " + d3.timeFormat('%Y')(sliderTime.value()));

        // Button Logic
        var retButton = document.getElementById("retButton").onclick =
          function() {
            console.log(cur_year);
            drawMainCanvas(cur_year);
          };

        // X axis init
        var x = d3.scaleBand()
          .range([ 0, width ])
          .padding(0.1);
        var xAxis = svg.append("g")
          .attr("transform", "translate(0," + height + ")")

        // Y axis init
        var y = d3.scaleLinear()
          .range([ height, 0]);
        var yAxis = svg.append("g");

        // Initialize at first year (2019)
        drawMainCanvas(cur_year);

        // Setup title text
        svg.append("text").attr("id", "title");

        /**** Scene draw helper ****/
        function drawMainCanvas(data_year) {
          // Grab this year's data and sort
          var cur_year_data = data.filter(function(d){ return d.Year == data_year.toString()})

          // Title
          svg.selectAll("#title").remove();
          svg.append("text")
            .attr("id", "title")
            .attr("x", (width / 2))             
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")  
            .style("font-size", "20px") 
            .text("Average Game Attendance in " + data_year);

          // hide return to main viz button
          d3.select("button")
            .style("visibility", "hidden");

          // Debugging
          // console.log(cur_year_data);
          // Update the X axis
          x.domain(cur_year_data.map(function(d) { return d.Tm; }));
          xAxis.transition().duration(1000).call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end");;

          // Update the Y axis
          y_max = d3.max(cur_year_data, function(d) { return Number(d.AttendG.replace(/\,/g,'')) });
          y.domain([0, y_max]);
          yAxis.transition().duration(1000).call(d3.axisLeft(y));

          cur_rects = svg.selectAll("rect").data(cur_year_data);

          // Add bars
          cur_rects.enter()
            .append("rect")
            .merge(cur_rects)
            .transition()
            .duration(1000)
                .attr("width", x.bandwidth())
                .attr("height", function (d) {
                  // console.log(height-y(d.AttendG.replace(/\,/g,'')));
                  return height-y(d.AttendG.replace(/\,/g,'')); })
                .attr("x", function(d) {
                  // console.log(x(d.Tm));
                  return x(d.Tm); })
                .attr("y", function(d) {
                  // console.log(d.AttendG.replace(/\,/g,''));
                  return y(d.AttendG.replace(/\,/g,'')); } )
                .attr("fill", function(d) {
                  // console.log(d.TmColor);
                  return d.TmColor; });
          svg.selectAll("rect").data(cur_year_data)
            .append("svg:title")
            .text(function(d) { return d.Tm; });

          // Tooltips on bars
          svg.selectAll("rect").data(cur_year_data)
            .on("mouseover", mouseover)
            .on("mouseleave", mouseleave)
            .on("click", mouseclick);

          cur_rects.exit().remove();
          
        }

        /**** Function to draw year over year change for a specific team ****/
        function drawDetailCanvas(team) {
          var cur_team_data = data.filter(function(d){ return d.Tm == team});
          console.log(svg.selectAll("#titel"));
          
          // Title
          svg.selectAll("#title").remove();
          svg.append("text")
            .attr("id", "title")
            .attr("x", (width / 2))             
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")  
            .style("font-size", "20px") 
            .text(cur_team_data[0].TmName + " Average Game Attendance per Year");

          // Show return to main viz button
          d3.select("button")
            .style("visibility", "visible");

          x.domain(cur_team_data.map(function(d) { return d.Year; }));
          xAxis.transition().duration(1000).call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end");;

          // Update the Y axis
          y_max = d3.max(cur_team_data, function(d) { return Number(d.AttendG.replace(/\,/g,'')) });
          y.domain([0, y_max]);
          yAxis.transition().duration(1000).call(d3.axisLeft(y));

          cur_rects = svg.selectAll("rect").data(cur_team_data);

          // Add bars
          cur_rects.enter()
            .append("rect")
            .merge(cur_rects)
            .transition()
            .duration(1000)
                .attr("width", x.bandwidth())
                .attr("height", function (d) {
                  // console.log(height-y(d.AttendG.replace(/\,/g,'')));
                  return height-y(d.AttendG.replace(/\,/g,'')); })
                .attr("x", function(d) {
                  // console.log(x(d.Tm));
                  return x(d.Year); })
                .attr("y", function(d) {
                  // console.log(d.AttendG.replace(/\,/g,''));
                  return y(d.AttendG.replace(/\,/g,'')); } )
                .attr("fill", function(d) {
                  // console.log(d.TmColor);
                  return d.TmColor; });
          svg.selectAll("rect").data(cur_team_data)
            .append("svg:title")
            .text(function(d) { return d.Tm; });

          // Tooltips on bars
          svg.selectAll("rect").data(cur_team_data)
            .on("mouseover", mouseover)
            .on("mouseleave", mouseleave);

          cur_rects.exit().remove();
        }
      });
    </script>
  </body>
</html>